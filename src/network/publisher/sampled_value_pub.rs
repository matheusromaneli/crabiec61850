use libc::nanosleep;

use crate::{network::{packet::Packet, socket::RawSocket}, protocols::{ethernet::model::Ethernet, sampled_values::model::SampledValue}};

pub fn main() {
    let socket = RawSocket::new("lo".to_string(), 0x88ba_u16);

    let sv_bytes: &[u8] = &[
        0x40, 0x02, 0x00, 0x66, 0x00, 0x00, 0x00, 0x00, // Header
        0x60, 0x5c, // PDU
        0x80, 0x01, 0x01, // number of ASDU
        0xa2, 0x57, // sequence of ASDU
        0x30, 0x55, 0x80, 0x04, 0x34, 0x30, 0x30, 0x30, 0x82, 0x02, 0x00, 0x00, 0x83, 0x04, 0x00, 0x00, 0x00,
        0x01, 0x85, 0x01, 0x01, 0x87, 0x40, 0xff, 0xff, 0xff, 0xfd, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x03, 0x00, 0x00, 0x20, 0x00, 0xff, 0xff, 0xff, 0xfd, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff,
        0xff, 0xfd, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff,
        0xff, 0xf6, 0x00, 0x00, 0x20, 0x00 // ASDU
    ];
    let mut config = Packet {
        ether_type: [0x88, 0xba],
        ethernet: Ethernet{
            dst_mac: [0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
            src_mac: [0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
            ether_type: [0x88, 0xba],
        },
        sampled_value: SampledValue::from_bytes(sv_bytes),
    };
    let time_between_packets = 208_333;
    let time_next_perf = 16;
    let time_to_bytes_perf = 900;
    let time_send_perf = 18_000;
    let unknown_time = 42_550;
    let tm_spec = libc::timespec {
        tv_sec: 0,
        tv_nsec: time_between_packets - time_next_perf - time_to_bytes_perf - time_send_perf - unknown_time,
    };

    loop {
        unsafe{ nanosleep(&tm_spec, core::ptr::null_mut()) };
        socket.send(&config.to_bytes());
        config.sampled_value.next();
    }
}